For maximize horizontal range we must change cost function.
$$J = -x_1(t_f)$$
Hamiltonian matrix:
$$\mathcal{H} =  g(\vec x(t), u(t), t) + {\vec{p}(t)}^Ta(\vec x(t), u(t), t)$$
$$\mathcal{H} = \begin{bmatrix} 
	p_1(t) & p_2(t) & p_3(t) & p_4(t)
\end{bmatrix} \begin{bmatrix}
	x_2(t)\\
	\dfrac{T}{M} \cos(u(t))\\
	x_4(t)\\
	\dfrac{T}{M} \sin(u(t))
\end{bmatrix}$$
\begin{equation} \label{HamiltonianQ2_d}
	\mathcal{H} = p_1(t)x_2(t) + \dfrac{T}{M}p_2(t)\cos(u(t)) +p_3(t)x_4(t) +\dfrac{T}{M}p_4(t)\sin(u(t))
\end{equation}
Eulerâ€“Lagrange equation:
\begin{align}
	\dot{\vec{x}} &= \dfrac{\partial \mathcal{H} }{\partial \vec{p}} = a(\vec x(t), u(t), t)\\
	\dot{\vec{p}} &= -\dfrac{\partial \mathcal{H} }{\partial \vec{x}} \\
	{\vec{0}} &= \dfrac{\partial \mathcal{H} }{\partial \vec{u}}
\end{align}
In this problem like previous we must satisfy Euler-Equation equation.
Now  we use equation \ref{HamiltonianQ2_d} to solve Euler-Lagrange equation.
\begin{equation}\label{diffpQ2_d}
	\begin{bmatrix}
		\dot{p_1}\\
		\dot{p_2}\\
		\dot{p_3}\\
		\dot{p_4}
	\end{bmatrix} = \begin{bmatrix}
		-\dfrac{\partial \mathcal{H}}{\partial x_1} \\[10 pt]
		-\dfrac{\partial \mathcal{H}}{\partial x_2} \\[10 pt]
		-\dfrac{\partial \mathcal{H}}{\partial x_3} \\[10 pt]
		-\dfrac{\partial \mathcal{H}}{\partial x_4} 
	\end{bmatrix} = \begin{bmatrix}
		0 \\
		-p_1\\
		0\\
		-p_3
	\end{bmatrix}
\end{equation} 
Answer of equation \ref{diffpQ2_a} is:
\begin{equation}\label{SolvepQ2_a}
	\begin{bmatrix}
		p_1(t)\\
		p_2(t)\\
		p_3(t)\\
		p_4(t)
	\end{bmatrix} = \begin{bmatrix}
		C_1\\
		-C_1t+C_2\\
		C_3\\
		-C_3t+C_4
	\end{bmatrix} 
\end{equation}
Boundary conditions:
$$t_0 = 0,\quad t_f = t_1$$
$$\vec{x}(0) = \begin{bmatrix}
	x_1(0) \\
	x_2(0) \\
	x_3(0) \\
	x_4(0) \\
\end{bmatrix}= \begin{bmatrix}
	0 \\
	0 \\
	0 \\
	0 \\
\end{bmatrix}, \quad
\vec{x}(t_f) = \begin{bmatrix}
	x_1(t_f) \\
	x_2(t_f) \\
	x_3(t_f) \\
	x_4(t_f) \\
\end{bmatrix}= \begin{bmatrix}
	\text{Free} \\
	\text{Free} \\
	D \\
	\text{Free} \\
\end{bmatrix}
(D\text{ is known constant})$$
Final $x_1$, $x_2$ and $x_4$ are free so:
\begin{equation}\label{Solvep_1Q2_d}
	\left.(\dfrac{\partial h}{\partial \vec x} - \vec p) \right \vert_{*, t_f} = \vec 0 \to \left
	.\begin{bmatrix}
		\dfrac{\partial h}{\partial \vec x_1} \\[10pt]
		\dfrac{\partial h}{\partial \vec x_2} \\[10pt]
		\dfrac{\partial h}{\partial \vec x_4} \\
	\end{bmatrix}\right \vert_{*, t_f} = \begin{bmatrix}
	-1 \\
	0 \\
	0
\end{bmatrix} = \begin{bmatrix}
p_1(t_f) \\
p_2(t_f) \\
p_4(t_f)
\end{bmatrix} 
\end{equation}